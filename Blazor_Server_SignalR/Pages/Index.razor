@page "/"

@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavManager
@implements IAsyncDisposable

<div class="form-group">
    <label>
        User: <input @bind="userInput"></input>
    </label>
</div>
<div class="form-group">
    <label>
        Message: <input @bind="msgInput"></input>
    </label>
</div>
<button @onclick="Send" disabled="@(EstaConectado == false)">Enviar</button>
<div style="border: 1px solid black;">
    <hr />
    <ul>
            @foreach (string msg in mensajes)
            {
                <li>@msg</li>
            }
    </ul>
</div>

<p ></p>


@code
{
    private HubConnection? hubConnection;
    private List<string> mensajes = new();
    private string? userInput;
    private string? msgInput;


    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder().WithUrl(NavManager.ToAbsoluteUri("/chathub")).WithAutomaticReconnect().Build();

        hubConnection.On<string, string>("RecibirMensaje", (user, msg) =>
        {
            var mensajeCompleto = $"{user}:  {msg}";
            mensajes.Add(mensajeCompleto);
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

    private async Task Send()
    {
        if (hubConnection is not null)
        {
            await hubConnection.SendAsync("EnviarMensaje", userInput, msgInput);
        }

    }

    public bool EstaConectado => hubConnection.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}